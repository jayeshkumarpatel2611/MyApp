name: Deploy POH Service

on: 
   workflow_dispatch:
      inputs:
         RingInfo:
            description: "RingInfo"
            required: true

jobs:

  ReadJSON:
    name: "Reading JSON Object"
    runs-on: ubuntu-latest
    outputs:
      service-deployment: ${{ steps.export-service-deployment-matrix.outputs.service-deployment }}
    steps:
    - uses: actions/checkout@v2

    - name: Export deployment matrix
      id: export-service-deployment-matrix
      run: |
        Ring="$( echo '${{ inputs.RingInfo }}' | jq '.[]' | jq -s '.' )"
        Ring="${Ring//'%'/'%25'}"
        Ring="${Ring//$'\n'/'%0A'}"
        Ring="${Ring//$'\r'/'%0D'}"
        echo "::set-output name=service-deployment::$Ring"
        
  createGithubWorkFlow:
    runs-on: ubuntu-latest
    needs: ReadJSON
    steps:
      - name: Install PowerShell
        run: |
             sudo apt-get update
             sudo apt-get install -y wget apt-transport-https software-properties-common
             wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
             sudo dpkg -i packages-microsoft-prod.deb
             sudo apt-get update
             sudo apt-get install -y powershell
      - name: checkout action files
        uses: actions/checkout@v2 
      - name : Create Github WorkFlow for POH Service Deployment     
        shell: pwsh
        run: |
             .\Scripts\createGithubWorflow.ps1 -Token '${{ secrets.MYAPPTOKEN }}' -RingInfo '${{ needs.ReadJSON.outputs.service-deployment}}'
