name: Deploy POH Service

on: 
   workflow_dispatch:
      inputs:
         RingInfo:
            description: "RingInfo"
            required: true

jobs:
  
  createGithubWorkFlow:
    runs-on: windows-latest
    steps:
      - name: checkout action files
        uses: actions/checkout@v2 
      - name : Create Github WorkFlow for POH Service Deployment     
        shell: powershell
        run: |
             .\Scripts\createGithubWorflow.ps1 -Token '${{ secrets.MYAPPTOKEN }}' -RingInfo '${{ inputs.RingInfo }}'


  Job1:
    runs-on: ubuntu-latest
    needs: createGithubWorkFlow
    steps:
      - name: checkout action files
        uses: actions/checkout@v2 
      - name : Update POH Service Deployment Status on Azure SQL Database     
        shell: pwsh
        run: |
              Write-Host "Job1 Completed"

              

  Job2:
    runs-on: ubuntu-latest
    needs: [createGithubWorkFlow, Job1] 
    if: ${{ always() }}
    steps:
      - name: checkout action files
        uses: actions/checkout@v2 
      - name: Azure Login
        uses: Azure/login@v1.4.3
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true
        
      - name : Update POH Service Deployment Status on Azure SQL Database 
        shell: pwsh
        run: |
              [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
              Install-Module -Name SqlServer -Scope CurrentUser -AllowClobber -Force -ErrorAction Stop -Confirm:$false  
              $ServerInstance = "myentdb.database.windows.net"
              $Database = "mydatabase"
              Write-Host "---------------------------------------------------------------------------------------"
              $cmd = "UPDATE [mydatabase].[dbo].[Persons] SET FirstName = 'Vaibhav' WHERE PersonId = '1004'" 
              Invoke-Sqlcmd -ServerInstance $ServerInstance -Database $Database -Query $cmd 
  
