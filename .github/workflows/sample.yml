name: Deploy Application

on:
  push:
    branches: [ master ]

jobs:
  create-deployment-artifacts:
    name: Create deployment artifacts
    runs-on: ubuntu-latest
    outputs:
      deployment-matrix: ${{ steps.export-service-deployment-matrix.outputs.service-deployment-matrix }}
    steps:
    - uses: actions/checkout@v2

    - name: Export deployment matrix
      id: export-service-deployment-matrix
      run: |
        JSON="$(cat ./service-deployment-matrix.json)"
        JSON="${JSON//'%'/'%25'}"
        JSON="${JSON//$'\n'/'%0A'}"
        JSON="${JSON//$'\r'/'%0D'}"
        echo "::set-output name=service-deployment-matrix::$JSON"

  prepare-release-on-servers:
    name: "Service Deployment - ${{ matrix.server.name }}"
    runs-on: ubuntu-latest
    needs: create-deployment-artifacts
    strategy:
      matrix:
        server: ${{ fromJson(needs.create-deployment-artifacts.outputs.service-deployment-matrix) }}

    steps:
    - name: Deploying Services
      with:
        host: ${{ matrix.server.ip }}
        username: ${{ matrix.server.username }}
        port: ${{ matrix.server.port }}
