name: Deploy Service
on: 
   workflow_dispatch:
    
    inputs:
      myInput:
        required: false
        type: string


jobs:
  ReadJSON:
    name: "Reading JSON Object"
    runs-on: ubuntu-latest
    outputs:
      service-deployment-matrix: ${{ toJSON(steps.export-service-deployment-matrix.outputs.service-deployment-matrix) }}
    steps:
    - uses: actions/checkout@v2

    - name: Export deployment matrix
      id: export-service-deployment-matrix
      run: |
        JSON="$(cat ./service-deployment-matrix.json)"
        JSON="${JSON//'%'/'%25'}"
        JSON="${JSON//$'\n'/'%0A'}"
        JSON="${JSON//$'\r'/'%0D'}"
        echo "::set-output name=service-deployment-matrix::$JSON"

  Ring:
    name: "${{ matrix.ring.displayName }}"
    runs-on: ubuntu-latest
    needs: [ReadJSON]
    strategy:
      matrix:
        ring: ${{ fromJSON(needs.ReadJSON.outputs.service-deployment-matrix) }}
    steps:
    - run: echo "${{ matrix.ring.displayName }} Approved"

  Region:
    name: "${{ matrix.regions.displayName }}"
    runs-on: ubuntu-latest
    needs: [ReadJSON,Ring]
    strategy:
      matrix:
        regions: ${{ fromJSON(needs.ReadJSON.outputs.service-deployment-matrix) }}
    steps:
    - run: echo "${{ matrix.regions.displayName }} Approved" 
    
  Location:
    name: "${{ matrix.locations.displayName }}"
    runs-on: ubuntu-latest
    needs: [ReadJSON,Region]
    strategy:
      matrix:
        locations: ${{ fromJSON(needs.ReadJSON.outputs.service-deployment-matrix) }}
    steps:
    - run: echo "${{ matrix.locations.displayName }} Approved"    
  
  EnvironmentTypes:
    name: "${{ matrix.envTypes.displayName }}"
    runs-on: ubuntu-latest
    needs: [ReadJSON,Location]
    strategy:
      matrix:
        envTypes: ${{ fromJSON(needs.ReadJSON.outputs.service-deployment-matrix) }}
    steps:
    - run: echo "${{ matrix.envTypes.displayName }} Approved"        

  Environments:
    name: "${{ matrix.envs.envTypes.envs.displayName }}"
    runs-on: ubuntu-latest
    needs: [ReadJSON,EnvironmentTypes]
    strategy:
      matrix:
        envs: ${{ fromJSON(needs.ReadJSON.outputs.service-deployment-matrix) }}
    steps:
    - run: echo "${{ matrix.envs.envTypes.envs.displayName }} Approved"
 